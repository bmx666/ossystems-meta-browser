From 58b0b91db2a3ac7bb78894479e2da7238db814f6 Mon Sep 17 00:00:00 2001
From: Takuro Ashie <ashie@clear-code.com>
Date: Sun, 14 Jul 2019 14:26:44 +0900
Subject: [PATCH] Bug 1451816 - Workarround for grabbing focus on weston

See https://bugzilla.mozilla.org/show_bug.cgi?id=1451816 for more
detail.

Upstream-Status: Denied [Fixed by GTK-3.24's new feature]

Signed-off-by: Takuro Ashie <ashie@clear-code.com>

---
 widget/gtk/nsWindow.cpp | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/widget/gtk/nsWindow.cpp b/widget/gtk/nsWindow.cpp
index b64fc87a94..8d661794db 100644
--- a/widget/gtk/nsWindow.cpp
+++ b/widget/gtk/nsWindow.cpp
@@ -129,6 +129,10 @@ using mozilla::gl::GLContextEGL;
 using mozilla::gl::GLContextGLX;
 #endif
 
+#ifdef MOZ_WAYLAND
+static bool gPointerGrabbed = false;
+#endif
+
 // Don't put more than this many rects in the dirty region, just fluff
 // out to the bounding-box if there are more
 #define MAX_RECTS_IN_REGION 100
@@ -4433,6 +4437,11 @@ void nsWindow::OnContainerFocusInEvent(GdkEventFocus* aEvent) {
 void nsWindow::OnContainerFocusOutEvent(GdkEventFocus* aEvent) {
   LOG("OnContainerFocusOutEvent");
 
+#ifdef MOZ_WAYLAND
+  if (gtk_check_version(3, 24, 0) != nullptr && gPointerGrabbed)
+    return;
+#endif
+
   if (mWindowType == eWindowType_toplevel ||
       mWindowType == eWindowType_dialog) {
     nsCOMPtr<nsIDragService> dragService =
@@ -6742,6 +6751,10 @@ void nsWindow::GrabPointer(guint32 aTime) {
   // Don't to the grab on Wayland as it causes a regression
   // from Bug 1377084.
   if (mIsDestroyed || GdkIsWaylandDisplay()) {
+#ifdef MOZ_WAYLAND
+    if (gtk_check_version(3, 24, 0) != nullptr)
+      gPointerGrabbed = true;
+#endif
     return;
   }
 
@@ -6796,6 +6809,10 @@ void nsWindow::ReleaseGrabs(void) {
   if (GdkIsWaylandDisplay()) {
     // Don't to the ungrab on Wayland as it causes a regression
     // from Bug 1377084.
+#ifdef MOZ_WAYLAND
+    if (gtk_check_version(3, 24, 0) != nullptr)
+      gPointerGrabbed = false;
+#endif
     return;
   }
 
